{"version":3,"file":"lazy-for.js","sources":["ng://lazy-for/lib/lazy-for.directive.ts","ng://lazy-for/lib/lazy-for.module.ts"],"sourcesContent":["import {\n  Directive,\n  DoCheck,\n  Input,\n  IterableDiffer,\n  IterableDiffers,\n  TemplateRef,\n  ViewContainerRef,\n} from \"@angular/core\";\n\n@Directive({\n  selector: \"[lazyFor]\",\n})\nexport class LazyForDirective implements DoCheck {\n  @Input(\"lazyForWithHeight\") itemHeight: number;\n  @Input(\"lazyForWithContainer\") containerElem: HTMLElement;\n  @Input(\"lazyForWithTagName\") itemTagName: string;\n\n  @Input()\n  set lazyForOf(list) {\n    this.list = list;\n\n    if (list) {\n      this.differ = this.iterableDiffers.find(list).create();\n\n      if (this.initialized) {\n        this.update();\n      }\n    }\n  }\n\n  private templateElem: HTMLElement;\n\n  private beforeListElem: HTMLElement;\n  private afterListElem: HTMLElement;\n\n  private list = [];\n\n  private initialized = false;\n  private firstUpdate = true;\n\n  private differ: IterableDiffer<any>;\n\n  private lastChangeTriggeredByScroll = false;\n\n  constructor(\n    private vcr: ViewContainerRef,\n    private tpl: TemplateRef<any>,\n    private iterableDiffers: IterableDiffers\n  ) {}\n\n  ngOnInit() {\n    this.templateElem = this.vcr.element.nativeElement;\n\n    if (this.containerElem === undefined) {\n      this.containerElem = this.templateElem.parentElement;\n    }\n\n    //Adding an event listener will trigger ngDoCheck whenever the event fires so we don't actually need to call\n    //update here.\n    this.containerElem.addEventListener(\"scroll\", (e) => {\n      this.lastChangeTriggeredByScroll = true;\n    });\n\n    this.initialized = true;\n  }\n\n  ngDoCheck() {\n    if (this.differ && Array.isArray(this.list)) {\n      if (this.lastChangeTriggeredByScroll) {\n        this.update();\n        this.lastChangeTriggeredByScroll = false;\n      } else {\n        let changes = this.differ.diff(this.list);\n\n        if (changes !== null) {\n          this.update();\n        }\n      }\n    }\n  }\n\n  // Clamps number within the inclusive lower and upper bounds.\n  private clamp(number: number, boundOne: number, boundTwo: number): number {\n    if (!boundTwo) {\n      return Math.max(number, boundOne) === boundOne ? number : boundOne; \n    } \n    \n    if (Math.min(number, boundOne) === number) {\n      return boundOne;\n    } \n    \n    if (Math.max(number, boundTwo) === number) {\n      return boundTwo;\n    }\n\n    return number;\n  }\n\n  private onFirstUpdate() {\n    let sampleItemElem: HTMLElement;\n\n    if (this.itemHeight === undefined || this.itemTagName === undefined) {\n      this.vcr.createEmbeddedView(this.tpl, { context: this.list[0], index: 0 });\n      sampleItemElem = <HTMLElement>this.templateElem.nextSibling;\n    }\n\n    if (this.itemHeight === undefined) {\n      this.itemHeight = sampleItemElem.clientHeight;\n    }\n\n    if (this.itemTagName === undefined) {\n      this.itemTagName = sampleItemElem.tagName;\n    }\n\n    this.beforeListElem = document.createElement(this.itemTagName);\n    this.templateElem.parentElement.insertBefore(this.beforeListElem, this.templateElem);\n\n    this.afterListElem = document.createElement(this.itemTagName);\n    //This inserts after the templateElem. see http://stackoverflow.com/a/4793630/373655 for details\n    this.templateElem.parentElement.insertBefore(this.afterListElem, this.templateElem.nextSibling);\n\n    if (this.itemTagName.toLowerCase() === 'li') {\n      this.beforeListElem.style.listStyleType = 'none';\n      this.afterListElem.style.listStyleType = 'none';\n    }\n\n    this.firstUpdate = false;\n  }\n\n  private update() {\n    if (this.list.length === 0) {\n      this.vcr.clear();\n      if (!this.firstUpdate) {\n        this.beforeListElem.style.height = '0';\n        this.afterListElem.style.height = '0';\n      }\n      return;\n    }\n\n    if (this.firstUpdate) {\n      this.onFirstUpdate();\n    }\n\n    let listHeight = this.containerElem.clientHeight;\n    let scrollTop = this.containerElem.scrollTop;\n\n    //The height of anything inside the container but above the lazyFor content;\n    let fixedHeaderHeight =\n      (this.beforeListElem.getBoundingClientRect().top - this.beforeListElem.scrollTop) -\n      (this.containerElem.getBoundingClientRect().top - this.beforeListElem.scrollTop);\n    \n    //This needs to run after the scrollTop is retrieved.\n    this.vcr.clear();\n\n    let listStartI = Math.floor((scrollTop - fixedHeaderHeight) / this.itemHeight);\n    listStartI = this.clamp(listStartI, 0, this.list.length);\n\n    let listEndI = Math.ceil((scrollTop - fixedHeaderHeight + listHeight) / this.itemHeight);\n    listEndI = this.clamp(listEndI, -1, this.list.length - 1);\n\n    for (let i = listStartI; i <= listEndI; i++) {\n      this.vcr.createEmbeddedView(this.tpl, { context: this.list[i], index: i });\n    }\n\n    this.beforeListElem.style.height = `${listStartI * this.itemHeight}px`;\n    this.afterListElem.style.height = `${(this.list.length - listEndI - 1) * this.itemHeight}px`;\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { LazyForDirective } from './lazy-for.directive';\n\n@NgModule({\n  declarations: [LazyForDirective],\n  exports: [LazyForDirective]\n})\nexport class LazyForModule { }\n"],"names":[],"mappings":"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"}